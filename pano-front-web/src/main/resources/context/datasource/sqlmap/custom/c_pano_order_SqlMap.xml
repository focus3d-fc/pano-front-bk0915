<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="c_pano_order" >
  <resultMap id="ibatorgenerated_BaseResultMap" class="com.focus3d.pano.model.PanoOrderModel" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Fri Aug 25 14:59:05 CST 2017.
    -->
    <result column="SN" property="sn" jdbcType="BIGINT" />
    <result column="ORDER_NUM" property="orderNum" jdbcType="VARCHAR" />
    <result column="ORDER_TIME" property="orderTime" jdbcType="TIMESTAMP" />
    <result column="STATUS" property="status" jdbcType="INTEGER" />
    <result column="ADDRESS_SN" property="addressSn" jdbcType="BIGINT" />
    <result column="USER_SN" property="userSn" jdbcType="BIGINT" />
    <result column="SUM_MONEY" property="sumMoney" jdbcType="DECIMAL" />
    <result column="DISCOUNT_MONEY" property="discountMoney" jdbcType="DECIMAL" />
    <result column="PAY_MONEY" property="payMoney" jdbcType="DECIMAL" />
    <result column="LEFT_MONEY" property="leftMoney" jdbcType="DECIMAL" />
    <result column="PAY_TIME" property="payTime" jdbcType="TIMESTAMP" />
    <result column="LEFT_PAY" property="leftPay" jdbcType="INTEGER" />
    <result column="PREPAY_ID" property="prepayId" jdbcType="VARCHAR" />
    <result column="EXTEND" property="extend" jdbcType="VARCHAR" />
    <result column="REMARK" property="remark" jdbcType="VARCHAR" />
    <result column="AGREE_CLAUSE" property="agreeClause" jdbcType="INTEGER" />
    <result column="PARENT_ORDER_SN" property="parentOrderSn" jdbcType="BIGINT" />
    <result column="ADDER_SN" property="adderSn" jdbcType="BIGINT" />
    <result column="ADDER_NAME" property="adderName" jdbcType="VARCHAR" />
    <result column="ADD_TIME" property="addTime" jdbcType="TIMESTAMP" />
    <result column="UPDATER_SN" property="updaterSn" jdbcType="BIGINT" />
    <result column="UPDATER_NAME" property="updaterName" jdbcType="VARCHAR" />
    <result column="UPDATE_TIME" property="updateTime" jdbcType="TIMESTAMP" />
  </resultMap>
  
  <select id="selectPayedOrders" resultMap="ibatorgenerated_BaseResultMap">
  SELECT 2 status,o.* FROM `pano_order`  o  WHERE 

o.user_sn=#userSn# AND ((
o.status='2' AND o.parent_order_sn=-1)
and  
IFNULL((SELECT STATUS  FROM `pano_order`  WHERE  parent_order_sn = o.sn ),2) != 1 

)
   ORDER BY o.order_time DESC
  </select>
  
  
  <select id="selectUnpayedOrders" resultMap="ibatorgenerated_BaseResultMap">
  SELECT 1 status,o.* FROM `pano_order`  o  WHERE 

o.user_sn=#userSn# AND (
(o.status=1 AND o.parent_order_sn=-1)
OR  
(o.left_pay = 1 AND (SELECT STATUS  FROM `pano_order`  WHERE  parent_order_sn = o.sn ) = 1 )

)
   ORDER BY o.order_time DESC
  </select>
  
   <select id="selectAllOrders" resultMap="ibatorgenerated_BaseResultMap">
  SELECT (CASE WHEN (o.parent_order_sn = -1 AND o.status=2 AND o.left_pay = 0) THEN 2
	 WHEN  (o.status = 1 OR (SELECT STATUS  FROM `pano_order`  WHERE  parent_order_sn = o.sn ) = 1 ) THEN 1
	ELSE 2
	END ) status,o.* FROM 
	`pano_order`  o  WHERE 

o.user_sn=#userSn# AND 
 o.parent_order_sn=-1
  ORDER BY o.order_time DESC
   
  </select>
</sqlMap>